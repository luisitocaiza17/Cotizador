diff --git a/src/com/qbe/cotizador/servicios/QBE/archivoPlano/GeneradorReporte.java b/src/com/qbe/cotizador/servicios/QBE/archivoPlano/GeneradorReporte.java
--- a/src/com/qbe/cotizador/servicios/QBE/archivoPlano/GeneradorReporte.java
+++ b/src/com/qbe/cotizador/servicios/QBE/archivoPlano/GeneradorReporte.java
@@ -262,6 +262,10 @@
 		calVigenciaHasta.setTime(detalleCotizacion.getFechaSiembra());
 		calVigenciaHasta.add(Calendar.DAY_OF_MONTH,Integer.parseInt(VigenciaCoberura.toString()==null?"0":VigenciaCoberura.toString()));
         Date fechaActual = new Date();
-		
+		if(cotizacion.getPuntoVenta().getNombre().equals("CREDIFE")){
+			parametersHeader.put("NombreBeneficiario","BANCO DEL PICHINCHA");
+		}else{
+			parametersHeader.put("NombreBeneficiario","COOPROGRESO");
+		}
 		parametersHeader.put("NumeroPoliza", detalleCotizacion.getId().toString());
 		parametersHeader.put("AeguradoNombre",detalleCotizacion.getnombresCliente() );
@@ -266,8 +270,8 @@
 		parametersHeader.put("NumeroPoliza", detalleCotizacion.getId().toString());
 		parametersHeader.put("AeguradoNombre",detalleCotizacion.getnombresCliente() );
-		parametersHeader.put("NombreBeneficiario",endosoBeneficiario.getBeneficiario().getNombre());
+		
 		parametersHeader.put("VigenciaDesde", Fecha.format(detalleCotizacion.getFechaSiembra()));
 		parametersHeader.put("NombreCultivo",(detalleCotizacion.getTipoCultivoNombre()==null?"":detalleCotizacion.getTipoCultivoNombre()));
 		parametersHeader.put("Tasa",""+detalleCotizacion.getTasa());
 		parametersHeader.put("DiasVigencia", Fecha.format(calVigenciaHasta.getTime()));
 		parametersHeader.put("PrecioAjuste", tipoCultivo.getPrecioAjuste());
@@ -269,7 +273,11 @@
 		parametersHeader.put("VigenciaDesde", Fecha.format(detalleCotizacion.getFechaSiembra()));
 		parametersHeader.put("NombreCultivo",(detalleCotizacion.getTipoCultivoNombre()==null?"":detalleCotizacion.getTipoCultivoNombre()));
 		parametersHeader.put("Tasa",""+detalleCotizacion.getTasa());
 		parametersHeader.put("DiasVigencia", Fecha.format(calVigenciaHasta.getTime()));
 		parametersHeader.put("PrecioAjuste", tipoCultivo.getPrecioAjuste());
-		parametersHeader.put("PrecioAjuste2", tipoCultivo.getPrecioAjuste2());
+		try{
+			parametersHeader.put("PrecioAjuste2", tipoCultivo.getPrecioAjuste2());
+		}catch(Exception e){
+			
+		}
 		parametersHeader.put("FechaEmision", Fecha.format(fechaActual.getTime()));
@@ -275,5 +283,4 @@
 		parametersHeader.put("FechaEmision", Fecha.format(fechaActual.getTime()));
-		
 		parametersHeader.put("SRC_IMAGE", "file:///"+rutaImage);
 		
 		String Html = GenerarContenido(html, parametersHeader);
diff --git a/src/com/qbe/cotizador/servicios/QBE/archivoPlano/ImportarCotizaciones.java b/src/com/qbe/cotizador/servicios/QBE/archivoPlano/ImportarCotizaciones.java
--- a/src/com/qbe/cotizador/servicios/QBE/archivoPlano/ImportarCotizaciones.java
+++ b/src/com/qbe/cotizador/servicios/QBE/archivoPlano/ImportarCotizaciones.java
@@ -84,7 +84,4 @@
 							//hallamos el beneficiario en base a la cotizacion:
 							CotizacionDAO cotizacionDAO = new CotizacionDAO();
 							Cotizacion  cotizacion =cotizacionDAO.buscarPorId(cotizacionId);
-									
-							EndosoBeneficiarioDAO endosoBeneficiarioDAO = new EndosoBeneficiarioDAO();
-							EndosoBeneficiario endosoBeneficiario = new EndosoBeneficiario();
 							
@@ -90,6 +87,11 @@
 							
-							endosoBeneficiario=endosoBeneficiarioDAO.buscarPorCotizacion(cotizacion);
-							respuesta.setBeneficiario(endosoBeneficiario.getBeneficiario().getNombre());
+							if(cotizacion.getEstado().getNombre().equals("Pendiente de Emitir")){
+								if(cotizacion.getPuntoVenta().getNombre().equals("CREDIFE")){
+									respuesta.setBeneficiario("BANCO PICHICHA");
+								}else{
+									respuesta.setBeneficiario("CREDIFE");
+								}
+							}
 							respuestaFinal[contador]=respuesta;
 							
 							
@@ -107,13 +109,13 @@
 						//hallamos el beneficiario en base a la cotizacion:
 						CotizacionDAO cotizacionDAO = new CotizacionDAO();
 						Cotizacion  cotizacion =cotizacionDAO.buscarPorId(cotizacionDetalle.getCotizacion().getId());
-								
-						EndosoBeneficiarioDAO endosoBeneficiarioDAO = new EndosoBeneficiarioDAO();
-						EndosoBeneficiario endosoBeneficiario = new EndosoBeneficiario();
-						
-						endosoBeneficiario=endosoBeneficiarioDAO.buscarPorCotizacion(cotizacion);
-						respuesta.setBeneficiario(endosoBeneficiario.getBeneficiario().getNombre());
-						
+						if(cotizacion.getEstado().getNombre().equals("Pendiente de Emitir")){
+							if(cotizacion.getPuntoVenta().getNombre().equals("CREDIFE")){
+								respuesta.setBeneficiario("BANCO PICHICHA");
+							}else{
+								respuesta.setBeneficiario("CREDIFE");
+							}
+						}
 						respuestaFinal[contador]=respuesta;
 					}
 					contador ++;
diff --git a/WebContent/dashboard/AgriCargaPreviaArchivoPlano.jsp b/WebContent/dashboard/AgriCargaPreviaArchivoPlano.jsp
--- a/WebContent/dashboard/AgriCargaPreviaArchivoPlano.jsp
+++ b/WebContent/dashboard/AgriCargaPreviaArchivoPlano.jsp
@@ -136,6 +136,8 @@
 		} else {
 			alert("Seleccione un archivo.");
 		}
+		
+		alert("Proceso terminado.");
 	}
 
 	function onUpload(e) {
diff --git a/WebContent/static/js/agricola/metodos.agricola.js b/WebContent/static/js/agricola/metodos.agricola.js
--- a/WebContent/static/js/agricola/metodos.agricola.js
+++ b/WebContent/static/js/agricola/metodos.agricola.js
@@ -2718,7 +2718,7 @@
 	$.ajax({url : "../AgriObjetoCotizacionController",
 		data : {
 			"cotizacionId" : $("#cotizacion_id").text(),
-			"tipoConsulta" : "crear",
+			"tipoConsulta" : "crearPronaca",
 			"provinciaId" : $("#ubicacion_provincia").val(),
 			"cantonId" : $("#ubicacion_Canton").val(),
 			"parroquiaId" : $("#ubicacion_Parroquia").val(),
diff --git a/WebContent/static/js/agricola/metodos.agricolaArchivoPlano.js b/WebContent/static/js/agricola/metodos.agricolaArchivoPlano.js
--- a/WebContent/static/js/agricola/metodos.agricolaArchivoPlano.js
+++ b/WebContent/static/js/agricola/metodos.agricolaArchivoPlano.js
@@ -1,6 +1,7 @@
 var tipoObjeto = document.getElementById("tipoObjetoMetodos").getAttribute(
 		"tipoObjetoValor");
 
+
 function formatDollar(num) {
 	var numero=parseFloat(num);
 	var p = numero.toFixed(2).split(".");
@@ -13,5 +14,5 @@
 
 	var puntoId = "";
 	if (puntoVentaId != null && puntoVentaId != '')
-		puntoId = puntoVentaId;
+		puntoId = "4271";
 	else
@@ -17,5 +18,5 @@
 	else
-		puntoId = $('#punto_venta').val();
+		puntoId = "4271";
 	$.ajax({
 		url : '../PuntoVentaController',
 		data : {
@@ -375,8 +376,8 @@
 						$("#punto_venta").val(seleccionada);
 						verificarPuntosVenta(seleccionada);
 					}else{
-						$("#punto_venta").val("4244");
-						verificarPuntosVenta("4244");
+						$("#punto_venta").val("4271");
+						verificarPuntosVenta("4271");
 					}
 					verificarPuntosVenta('');
 					obtenerFormaPagoXPV('');
diff --git a/src/com/qbe/cotizador/dao/producto/agricola/AgriTipoCultivoDAO.java b/src/com/qbe/cotizador/dao/producto/agricola/AgriTipoCultivoDAO.java
--- a/src/com/qbe/cotizador/dao/producto/agricola/AgriTipoCultivoDAO.java
+++ b/src/com/qbe/cotizador/dao/producto/agricola/AgriTipoCultivoDAO.java
@@ -14,6 +14,7 @@
 import com.qbe.cotizador.model.AgriTipoCultivo;
 
 public class AgriTipoCultivoDAO extends EntityManagerFactoryDAO<AgriTipoCultivo>  {
+	
 
 	@PersistenceContext(name="CotizadorWebPC", unitName = "CotizadorWebPU" )	
 	private EntityManager em;
@@ -92,4 +93,9 @@
 	{
 		return getEntityManager().createNamedQuery("AgriTipoCultivo.buscarTodosCodIntOtros").setParameter("codigo",codigo).getResultList();
 	}
+	
+	public  List<AgriTipoCultivo>BuscarTodosSimilare(String codigo)
+	{
+		return getEntityManager().createNamedQuery("AgriTipoCultivo.buscarPorCoincidencias").setParameter("codigo","%"+codigo+"%").getResultList();
+	}
 }
diff --git a/src/com/qbe/cotizador/model/DerechoEmision.java b/src/com/qbe/cotizador/model/DerechoEmision.java
--- a/src/com/qbe/cotizador/model/DerechoEmision.java
+++ b/src/com/qbe/cotizador/model/DerechoEmision.java
@@ -10,7 +10,7 @@
  */
 @Entity
 @Table(name="DERECHO_EMISION")
-@NamedQuery(name="DerechoEmision.findAll", query="SELECT d FROM DerechoEmision d")
+@NamedQuery(name="DerechoEmision.BuscarTodos", query="SELECT d FROM DerechoEmision d")
 public class DerechoEmision implements Serializable {
 	private static final long serialVersionUID = 1L;
 
@@ -32,6 +32,7 @@
 
 	public DerechoEmision() {
 	}
+	
 
 	public String getId() {
 		return this.id;
diff --git a/src/com/qbe/cotizador/servlets/producto/agricola/AgriCargaPreviaArchivoPlanoController.java b/src/com/qbe/cotizador/servlets/producto/agricola/AgriCargaPreviaArchivoPlanoController.java
--- a/src/com/qbe/cotizador/servlets/producto/agricola/AgriCargaPreviaArchivoPlanoController.java
+++ b/src/com/qbe/cotizador/servlets/producto/agricola/AgriCargaPreviaArchivoPlanoController.java
@@ -83,6 +83,11 @@
 					List<FileItem> items = upload.parseRequest(request);
 					for (FileItem item : items) {
 						if (!item.isFormField()) {							
-
+							String rutaPlantilla = AgriSucreNotificacionErrores.class.getProtectionDomain().getCodeSource()
+									.getLocation().getPath();
+							rutaPlantilla=rutaPlantilla.replace("AgriSucreNotificacionErrores.class", "");
+							String rutaRelativaReporte="../../../../../../../../static/CotizacionesArchivoPlano/";
+							rutaPlantilla=rutaPlantilla+rutaRelativaReporte;
+							
 							String fileName = item.getName();
 							try {
@@ -87,6 +92,6 @@
 							String fileName = item.getName();
 							try {
-								File saveFile = new File("../eclipseApps/Cotizador/static/CotizacionesArchivoPlano",fileName);
+								File saveFile = new File(rutaPlantilla,fileName);
 								saveFile.createNewFile();
 								item.write(saveFile);								
 							} catch (Exception e) {
@@ -140,6 +145,7 @@
 				FileInputStream input = new FileInputStream(rutaPlantilla);
 				List<CotizacionArchivoPlano> cotizacionList = new ArrayList<CotizacionArchivoPlano>();
 				
+				
 				if(nombreArchivo.endsWith(".xlsx")){
 					cotizacionList = ReadExelFile.readXLSXFile(rutaPlantilla);		
 				}else if(nombreArchivo.endsWith(".xls")){
diff --git a/src/com/qbe/cotizador/servlets/producto/agricola/AgriEmisionPoliza.java b/src/com/qbe/cotizador/servlets/producto/agricola/AgriEmisionPoliza.java
--- a/src/com/qbe/cotizador/servlets/producto/agricola/AgriEmisionPoliza.java
+++ b/src/com/qbe/cotizador/servlets/producto/agricola/AgriEmisionPoliza.java
@@ -6,6 +6,7 @@
 import java.util.Calendar;
 import java.util.Date;
 import java.util.List;
+
 import com.qbe.cotizador.dao.cotizacion.CotizacionDAO;
 import com.qbe.cotizador.dao.cotizacion.CotizacionDetalleDAO;
 import com.qbe.cotizador.dao.cotizacion.EndosoBeneficiarioDAO;
@@ -50,6 +51,10 @@
 import com.qbe.cotizador.transaction.cotizacion.CotizacionTransaction;
 import com.qbe.cotizador.transaction.cotizacion.EndosoBeneficiarioTransaction;
 import com.qbe.cotizador.transaction.entidad.DireccionTransaction;
+import com.qbe.cotizador.transaction.entidad.EntidadTransaction;
+import com.qbe.cotizador.util.Utilitarios;
+import com.qbe.ensurance.services.WSActualizarCrearEntidadesONBASE.WSActualizarCrearEntidadesONBASEProxy;
+import com.tandi.entidad.dto.EntidadWSONBASE;
 
 public class AgriEmisionPoliza {
 	public static AgriResultadoEmision emitirPoliza(String cotizacionId){
@@ -129,9 +134,9 @@
 		}
 		
 		//Creo la entidad en ensurance y actualizo el id en la entidad del cotizador
-		/*String resultadoCrearEntidad=crearActualizarEntidad(cotizacion.getAsegurado());
+		String resultadoCrearEntidad=crearActualizarEntidad(cotizacion.getAsegurado());
 		if(!resultadoCrearEntidad.equals("")){
 			Entidad entidad=cotizacion.getAsegurado();
 			entidad.setEntEnsurance(resultadoCrearEntidad);
 			EntidadTransaction entidadTrans=new EntidadTransaction();
 			entidadTrans.editar(entidad);
@@ -133,9 +138,9 @@
 		if(!resultadoCrearEntidad.equals("")){
 			Entidad entidad=cotizacion.getAsegurado();
 			entidad.setEntEnsurance(resultadoCrearEntidad);
 			EntidadTransaction entidadTrans=new EntidadTransaction();
 			entidadTrans.editar(entidad);
-		}*/
+		}
 		
 			
 		AgriResultadoEmision nuevoResultado=new AgriResultadoEmision();
@@ -150,37 +155,41 @@
 					String resultado=emisionAgricola.emisionPoliza(nuevoResultado.getXmlEmision(), "f2rtiUdv2kjOgaCx");
 					if(!resultado.equals("")){
 						if (!resultado.contains("ERROR")){
-						CotizacionTransaction cotizacionTransaction = new CotizacionTransaction();
-						//String[] ids=resultado.split(" ");
-						String[] ids=resultado.split(" ");
-						if(ids.length!=0){
-							//String[] ids2=ids[1].split("::");
-							String[] ids2=ids[12].split("::");
-							if(ids2.length!=0){
-								CotizacionRespuesta cotizacionRes = new CotizacionRespuesta();
-								CotizacionRespuestaTransaction cotiResTransaction = new CotizacionRespuestaTransaction();
-								EstadoDAO estadoDAO = new EstadoDAO();
-								Estado estado = estadoDAO.buscarPorNombre("Emitido", "Cotizacion");
-								if (!cotizacion.getEstado().getNombre().equals(estado.getId())){
-									cotizacion.setNumeroFactura(ids2[0].trim());
-									nuevoResultado.setFactura(ids2[0].trim());
-									cotizacion.setEstado(estado);
-									///TODO:tualiza estado tabla cotizacion
-									cotizacion = cotizacionTransaction.editar(cotizacion);
-									//TODO: Se graba en cotizacion respuesta 
-									cotizacionRes.setCotizacionId(new BigInteger(cotizacion.getId()));
-									cotizacionRes.setPolizaId(cotizacion.getNumeroFactura());
-									cotizacionRes.setFacturaNumero(cotizacion.getNumeroFactura());
-									cotizacionRes.setFechaEmision(ids2[1].trim());
-									cotizacionRes = cotiResTransaction.crear(cotizacionRes);
-									
-									nuevoResultado.setEmitidoCorrectamente(true);
-									return nuevoResultado;
-								}
-								else {
-									nuevoResultado.setEmitidoCorrectamente(false);
-									nuevoResultado.setMensaje("La cotización fue emitida anteriormente");
-									return nuevoResultado;
+							if(resultado.substring(0, 23).equals("El numero de la poliza:")){
+								nuevoResultado.setEmitidoCorrectamente(false);
+								nuevoResultado.setMensaje("Ya existe en Ensurance. ");
+								return nuevoResultado;
+							}
+							CotizacionTransaction cotizacionTransaction = new CotizacionTransaction();
+							String[] ids=resultado.split(" ");
+							if(ids.length!=0){
+								String[] ids2=ids[0].split("::");
+								if(ids2.length!=0){
+									String [] factura = ids2[0].replace("|"," ").split(" ");
+									CotizacionRespuesta cotizacionRes = new CotizacionRespuesta();
+									CotizacionRespuestaTransaction cotiResTransaction = new CotizacionRespuestaTransaction();
+									EstadoDAO estadoDAO = new EstadoDAO();
+									Estado estado = estadoDAO.buscarPorNombre("Emitido", "Cotizacion");
+									if (!cotizacion.getEstado().getNombre().equals(estado.getId())){
+										cotizacion.setNumeroFactura(factura[1].trim());
+										nuevoResultado.setFactura(factura[0].trim());
+										cotizacion.setEstado(estado);
+										///TODO:tualiza estado tabla cotizacion
+										cotizacion = cotizacionTransaction.editar(cotizacion);
+										//TODO: Se graba en cotizacion respuesta 
+										cotizacionRes.setCotizacionId(new BigInteger(cotizacion.getId()));
+										cotizacionRes.setPolizaId(cotizacion.getNumeroFactura());
+										cotizacionRes.setFacturaNumero(cotizacion.getNumeroFactura());
+										cotizacionRes.setFechaEmision(ids2[1].trim());
+										cotizacionRes = cotiResTransaction.crear(cotizacionRes);
+										nuevoResultado.setEmitidoCorrectamente(true);
+										return nuevoResultado;
+									}
+									else {
+										nuevoResultado.setEmitidoCorrectamente(false);
+										nuevoResultado.setMensaje("La cotización fue emitida anteriormente");
+										return nuevoResultado;
+									}
 								}
 							}
 						}
@@ -184,7 +193,6 @@
 								}
 							}
 						}
-						}
 						else {
 							nuevoResultado.setEmitidoCorrectamente(false);
 							nuevoResultado.setMensaje("Error en el proceso de emisión de Ensurance. "+resultado);
@@ -217,7 +225,7 @@
 		return nuevoResultado;
 	}
 
-/*	private static String crearActualizarEntidad(Entidad entidad){
+	private static String crearActualizarEntidad(Entidad entidad){
 		String ciudad="";
 		String direccion="";
 		String provincia="";
@@ -259,8 +267,8 @@
 		entidadEnsurance.setTitulo("");
 		
 		entidadEnsurance.setPuerto("8084");
-		entidadEnsurance.setUsuario("dchaguaro");
-		entidadEnsurance.setPassword("pruebas");
+		entidadEnsurance.setUsuario("WS_AGRICOLA");
+		entidadEnsurance.setPassword("5sMCNw4JQhUyIENa");
 		
 		String result="";
 		try
@@ -271,7 +279,7 @@
 		}
 		
 		return result;
-	}*/
+	}
 	
 	private static AgriResultadoEmision generarXML(Cotizacion cotizacion){
 		AgriResultadoEmision resultado=new AgriResultadoEmision();
@@ -363,9 +371,11 @@
 			return resultado;
 		}
 		
-		EndosoBeneficiario endosoBeneficiario= endosoBeneficiarioDAO.buscarPorCotizacion(cotizacion);
-		if(endosoBeneficiario!=null){
-			if (endosoBeneficiario.getId()==null){
+		
+		EndosoBeneficiario endosoBeneficiario = endosoBeneficiarioDAO.buscarPorCotizacion(cotizacion);
+		
+			if (endosoBeneficiario == null){
+				endosoBeneficiario = new EndosoBeneficiario();
 				//TODO:COntrolar que el ensodoso beneficiario se cree solo para banca comunal y credife 
 				EndosoBeneficiarioTransaction endosoBeneficiarioTransaction = new EndosoBeneficiarioTransaction();
 				BeneficiarioDAO beneficiarioDAO = new BeneficiarioDAO();
@@ -375,7 +385,7 @@
 				endosoBeneficiario.setMonto(cotizacion.getSumaAseguradaTotal());
 				endosoBeneficiario=endosoBeneficiarioTransaction.crear(endosoBeneficiario);
 			}
-		}
+		
 
 		Calendar c = Calendar.getInstance(); 
 		c.setTime(objetoCotizacion.getFechaSiembra()); 
@@ -394,5 +404,5 @@
 		
 		String fechaFinalCultivo = df.format(vigenciaHasta);
 		
-		long fechaInicioPoliza = cotizacion.getVigenciaDesde().getTime();
+		long fechaInicioPoliza = cotizacion.getVigenciaDesde().getTime()/1000;
 		
@@ -398,5 +408,5 @@
 		
-		long fechaFinalPoliza = vigenciaPolHasta.getTime();
+		long fechaFinalPoliza = vigenciaPolHasta.getTime()/1000;
 		/*Date fechaAprobacion=new Date();
 		SimpleDateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
 		try{
@@ -406,8 +416,8 @@
 			.append("<puerto>8084</puerto>")
 		}*/
 		StringBuilder xml=new StringBuilder("<superObjetoXML><detallesPoliza><identificador>").append(cotizacion.getId()).append("</identificador>")
-		.append("<login>SMARTWORK</login>")
+		.append("<login>WS_AGRICOLA</login>")
 		.append("<pass>5sMCNw4JQhUyIENa</pass>")
 		.append("<agenteId>").append(agente.getAgeEnsurance()).append("</agenteId>")
 		.append("<porcentajeComision>").append(cotizacion.getPorcentajeComision()).append("</porcentajeComision>")
 		.append("<valorprima>").append(cotizacion.getPrimaNetaTotal()).append("</valorprima>")
@@ -410,10 +420,10 @@
 		.append("<pass>5sMCNw4JQhUyIENa</pass>")
 		.append("<agenteId>").append(agente.getAgeEnsurance()).append("</agenteId>")
 		.append("<porcentajeComision>").append(cotizacion.getPorcentajeComision()).append("</porcentajeComision>")
 		.append("<valorprima>").append(cotizacion.getPrimaNetaTotal()).append("</valorprima>")
-		.append("<canalId>26346</canalId>")
-		.append("<contenedorId>").append("6253472317840").append("</contenedorId>")
-		.append("<loteImpresion>LOTE Credifé_2015-07-02</loteImpresion>")
+		.append("<canalId>").append(parametroXPV.getCanalId()).append("</canalId>")
+		.append("<contenedorId>").append(contenedorId).append("</contenedorId>")
+		.append("<loteImpresion>").append(puntoVenta.getNombre()+"_"+Utilitarios.actualDate()).append("</loteImpresion>")
 		.append("<puntoVentaId>")
 		.append(puntoVenta.getPtoEnsurance())
 		.append("</puntoVentaId>")
@@ -423,7 +433,7 @@
 		.append("<monedaId>11141120</monedaId>")
 		.append("<plantillaId>").append(plantillaId).append("</plantillaId>")
 		.append("<firmaDigitalId>1</firmaDigitalId>")
-		.append("<usuarioActualiza>5829986617978</usuarioActualiza>")
+		.append("<usuarioActualiza>10822106152960</usuarioActualiza>")
 		.append("<ramoId>7274513</ramoId>")
 		.append("<mnemotecnicoRamo>SA</mnemotecnicoRamo>")
 		.append("<unidadNegocioId>").append(productoXPV.getUnidadNegocio().getUnEnsurance()).append("</unidadNegocioId>")
@@ -440,7 +450,7 @@
 		.append("</detallesPoliza>")
 		.append("<loteCultivo>")
 		.append("<loteCultivoId>-1</loteCultivoId>")
-		.append("<nombre>LOTE CREDIFE_2015-07-02</nombre>")
+		.append("<nombre>").append(puntoVenta.getNombre()+"_"+Utilitarios.actualDate()).append("</nombre>")
 		.append("<valorAsegurado>").append(cotizacion.getSumaAseguradaTotal()).append("</valorAsegurado>")
 		.append("<numeroHectareas>").append(objetoCotizacion.getHectareasLote()).append("</numeroHectareas>")
 		.append("<valorPorHectarea>").append(objetoCotizacion.getCostoProduccion()).append("</valorPorHectarea>")
@@ -453,7 +463,7 @@
 		.append("<finVigenciaCultivo>").append(fechaFinalCultivo).append("</finVigenciaCultivo>")
 		//.append("<inicioVigenciaCultivo>").append("06/11/2015").append("</inicioVigenciaCultivo>")
 		//.append("<finVigenciaCultivo>").append("06/02/2016").append("</finVigenciaCultivo>")
-		.append("<variedad>DE VERANO</variedad>")
+		.append("<variedad>").append(objetoCotizacion.getVariedad()).append("</variedad>")
 		.append("<numeroHectareasAsegurables>").append(objetoCotizacion.getHectareasAsegurables()).append("</numeroHectareasAsegurables>")
 		.append("<esTecnificado>Si</esTecnificado>")
 		//.append("<fechaTentativaSiembra>").append("06/11/2015").append("</fechaTentativaSiembra>")
@@ -463,7 +473,8 @@
 
 		.append("<cliente>")
 		.append("<id>no</id>")
-		.append("<entidadId>").append(cliente.getEntidad().getEntEnsurance()).append("</entidadId>")
+				.append("<entidadId>")
+				.append(cliente.getEntidad().getEntEnsurance()==null?"no":cliente.getEntidad().getEntEnsurance()).append("</entidadId>")
 		.append("<nombres>").append(cliente.getEntidad().getNombres()).append("</nombres>")
 		.append("<apellidos>").append(cliente.getEntidad().getApellidos()).append("</apellidos>")
 		.append("<tipoIdentificacion>")
@@ -473,7 +484,7 @@
 		.append("<identificacion>").append(cliente.getEntidad().getIdentificacion()).append("</identificacion>")
 		.append("<genero>f</genero>")
 		.append("<esEmpresa>")
-		.append(cliente.getEntidad().getTipoIdentificacion().getId()=="1" ? "false":cliente.getEntidad().getTipoIdentificacion().getId()=="2" ? "false":"true")
+		.append(cliente.getEntidad().getTipoIdentificacion().getId()=="1" ? "false":cliente.getEntidad().getTipoIdentificacion().getId()=="2" ? "false":cliente.getEntidad().getTipoIdentificacion().getId()=="3"?"false":"true")
 		.append("</esEmpresa>")
 		.append("<DireccionDTO><direccion>")
 		.append("<paisId>6815744</paisId>")
@@ -494,7 +505,7 @@
 		.append(" ")
 		.append(cliente.getEntidad().getDireccions().get(0).getCalleSecundaria())
 		.append("</direccion>")
-		.append("<telefono>").append(cliente.getEntidad().getTelefono()).append("</telefono>")
+		.append("<telefono>").append((cliente.getEntidad().getTelefono()!=null && !cliente.getEntidad().getTelefono().equals("")) ? cliente.getEntidad().getTelefono():"-").append("</telefono>")
 		.append("</direccion></DireccionDTO>")
 		.append("</cliente>")
 
@@ -510,7 +521,7 @@
 		.append("<identificacion>").append(cotizacion.getAsegurado().getIdentificacion()).append("</identificacion>")
 		.append("<genero>f</genero>")
 		.append("<esEmpresa>")
-		.append(cotizacion.getAsegurado().getTipoIdentificacion().getId()=="1" ? "false":cotizacion.getAsegurado().getTipoIdentificacion().getId()=="2" ? "false":"true")
+		.append(cotizacion.getAsegurado().getTipoIdentificacion().getId()=="1" ? "false":cotizacion.getAsegurado().getTipoIdentificacion().getId()=="2" ? "false":cotizacion.getAsegurado().getTipoIdentificacion().getId()=="3"?"false":"true")
 		.append("</esEmpresa>")
 		.append("<DireccionDTO><direccion>")
 		.append("<paisId>6815744</paisId>")
@@ -532,7 +543,7 @@
 		.append(" ")
 		.append(cotizacion.getAsegurado().getDireccions().get(0).getCalleSecundaria())
 		.append("</direccion>")
-		.append("<telefono>").append(cotizacion.getAsegurado().getTelefono()).append("</telefono>")
+		.append("<telefono>").append((cotizacion.getAsegurado().getTelefono()!=null && !cotizacion.getAsegurado().getTelefono().equals("")) ? cotizacion.getAsegurado().getTelefono():"-").append("</telefono>")
 		.append("</direccion></DireccionDTO>")
 		.append("</asegurado>");
 		if(endosoBeneficiario!=null){
@@ -543,8 +554,8 @@
 			.append("<nombres>").append(endosoBeneficiario.getBeneficiario().getNombre()).append("</nombres>")
 			.append("<apellidos>").append(endosoBeneficiario.getBeneficiario().getNombre()).append("</apellidos>")
 			.append("<tipoIdentificacion>")
-			.append(entidadBeneficiario.getTipoIdentificacion().getId()=="1" ? "c":cliente.getEntidad().getTipoIdentificacion().getId()=="2" ? "p":"r")
+			.append(entidadBeneficiario.getTipoIdentificacion().getId()=="1" ? "c":entidadBeneficiario.getTipoIdentificacion().getId()=="2" ? "p":"r")
 			.append("</tipoIdentificacion>")
 			.append("<tipoEntidadId>").append(entidadBeneficiario.getTipoEntidad().getId()).append("</tipoEntidadId>")
 			.append("<identificacion>").append(entidadBeneficiario.getIdentificacion()).append("</identificacion>")
 			.append("<esEmpresa>")
@@ -547,8 +558,8 @@
 			.append("</tipoIdentificacion>")
 			.append("<tipoEntidadId>").append(entidadBeneficiario.getTipoEntidad().getId()).append("</tipoEntidadId>")
 			.append("<identificacion>").append(entidadBeneficiario.getIdentificacion()).append("</identificacion>")
 			.append("<esEmpresa>")
-			.append(cotizacion.getAsegurado().getTipoIdentificacion().getId()=="1" ? "false":cotizacion.getAsegurado().getTipoIdentificacion().getId()=="2" ? "false":"true")
+			.append(entidadBeneficiario.getTipoIdentificacion().getId()=="1" ? "false":entidadBeneficiario.getTipoIdentificacion().getId()=="2" ? "false":entidadBeneficiario.getTipoIdentificacion().getId()=="3"?"false":"true")
 			.append("</esEmpresa>")
 			.append("<DireccionDTO>")
 			.append("<direccion>")
diff --git a/src/com/qbe/cotizador/servlets/producto/agricola/AgriObjetoCotizacionController.java b/src/com/qbe/cotizador/servlets/producto/agricola/AgriObjetoCotizacionController.java
--- a/src/com/qbe/cotizador/servlets/producto/agricola/AgriObjetoCotizacionController.java
+++ b/src/com/qbe/cotizador/servlets/producto/agricola/AgriObjetoCotizacionController.java
@@ -5,8 +5,9 @@
 import java.text.SimpleDateFormat;
 import java.util.Date;
 import java.util.List;
+
 import javax.servlet.ServletException;
 import javax.servlet.annotation.WebServlet;
 import javax.servlet.http.HttpServlet;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
@@ -8,6 +9,7 @@
 import javax.servlet.ServletException;
 import javax.servlet.annotation.WebServlet;
 import javax.servlet.http.HttpServlet;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
+
 import net.sf.json.JSONObject;
@@ -13,4 +15,5 @@
 import net.sf.json.JSONObject;
+
 import com.qbe.cotizador.dao.cotizacion.CotizacionDAO;
 import com.qbe.cotizador.dao.cotizacion.CotizacionDetalleDAO;
 import com.qbe.cotizador.dao.cotizacion.EstadoDAO;
@@ -18,9 +21,10 @@
 import com.qbe.cotizador.dao.entidad.ClienteDAO;
 import com.qbe.cotizador.dao.entidad.DerechoEmisonDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriCicloDAO;
+import com.qbe.cotizador.dao.producto.agricola.AgriCotizacionMaxDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriObjetoCotizacionDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriReglaDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriTipoCalculoDAO;
 import com.qbe.cotizador.dao.seguridad.TipoVariableDAO;
 import com.qbe.cotizador.dao.seguridad.VariableSistemaDAO;
 import com.qbe.cotizador.model.AgriCiclo;
@@ -21,9 +25,10 @@
 import com.qbe.cotizador.dao.producto.agricola.AgriObjetoCotizacionDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriReglaDAO;
 import com.qbe.cotizador.dao.producto.agricola.AgriTipoCalculoDAO;
 import com.qbe.cotizador.dao.seguridad.TipoVariableDAO;
 import com.qbe.cotizador.dao.seguridad.VariableSistemaDAO;
 import com.qbe.cotizador.model.AgriCiclo;
+import com.qbe.cotizador.model.AgriCotizacionMax;
 import com.qbe.cotizador.model.AgriObjetoCotizacion;
 import com.qbe.cotizador.model.AgriRegla;
 import com.qbe.cotizador.model.AgriTipoCalculo;
@@ -32,6 +37,7 @@
 import com.qbe.cotizador.model.CotizacionDetalle;
 import com.qbe.cotizador.model.DerechoEmision;
 import com.qbe.cotizador.model.Estado;
+import com.qbe.cotizador.model.SumaAsegurada;
 import com.qbe.cotizador.model.TipoVariable;
 import com.qbe.cotizador.model.VariableSistema;
 import com.qbe.cotizador.transaction.cotizacion.CotizacionDetalleTransaction;
@@ -232,6 +238,7 @@
 						agriObjetoCotizacion.setDisponeAsistencia(Boolean.parseBoolean(disponeAsistencia));
 						agriObjetoCotizacion.setAgricultorTecnificado(Boolean.parseBoolean(agricultorTecnificado));
 						agriObjetoCotizacion.setDireccionSiembra(direccionSiembra);
+						agriObjetoCotizacion.setCostoProduccionQBE(Float.parseFloat(""+sumaAseguradaTotal));
 						if(!aniosCultivo.equals(""))
 							agriObjetoCotizacion.setAniosCultivo(Integer.parseInt(aniosCultivo));
 						if(!tipoSeguro.equals(""))
@@ -276,4 +283,5 @@
 						
 						agriObjetoCotizacion.setTipoCalculo(reglaId);
 						agriObjetoCotizacion.setObservacion(reglaDetalle);
+						/***Proceso de creacion de las IdCotizaciones para facturacion***/
 						
@@ -279,4 +287,9 @@
 						
+						AgriCotizacionMaxDAO busquedaMax = new AgriCotizacionMaxDAO();
+						AgriCotizacionMax numMaximo=busquedaMax.buscarTodos();
+						int numeroActual=numMaximo.getMaximo().intValue();
+						
+						agriObjetoCotizacion.setIdCotizacion2(new BigInteger(""+(numeroActual+1)));
 						agriObjetoCotizacion=agriObjetoCotizacionTransaction.crear(agriObjetoCotizacion);
 
 						//Creo la cotización detalle
@@ -388,6 +401,320 @@
 				}
 			}
 			
+			if(tipoConsulta.equalsIgnoreCase("crearPronaca"))
+			{
+				String cotizacionId = request.getParameter("cotizacionId") == null ? "" : request.getParameter("cotizacionId").trim();
+				String provinciaId = request.getParameter("provinciaId") == null ? "" : request.getParameter("provinciaId");
+				String cantonId = request.getParameter("cantonId") == null ? "" : request.getParameter("cantonId");
+				String parroquiaId = request.getParameter("parroquiaId") == null ? "" : request.getParameter("parroquiaId");
+				String direccionSiembra = request.getParameter("direccionSiembra") == null ? "" : request.getParameter("direccionSiembra").trim();
+				String altitudNivelMar = request.getParameter("altitudNivelMar") == null ? "" : request.getParameter("altitudNivelMar").trim();
+				String fechaCredito = request.getParameter("fechaCredito") == null ? "" : request.getParameter("fechaCredito").trim();
+				String montoCredito = request.getParameter("montoCredito") == null ? "" : request.getParameter("montoCredito").trim();
+				String tipoCultivoId = request.getParameter("tipoCultivoId") == null ? "" : request.getParameter("tipoCultivoId").trim();
+				String variedad = request.getParameter("variedad") == null ? "" : request.getParameter("variedad").trim();
+				String fechaSiembra = request.getParameter("fechaSiembra") == null ? "" : request.getParameter("fechaSiembra").trim();
+				String hectareasLote = request.getParameter("hectareasLote") == null ? "" : request.getParameter("hectareasLote").trim();
+				String hectareasAsegurables = request.getParameter("hectareasAsegurables") == null ? "" : request.getParameter("hectareasAsegurables").trim();
+				String agricultorTecnificado = request.getParameter("agricultorTecnificado") == null ? "" : request.getParameter("agricultorTecnificado").trim();
+				String latitud = request.getParameter("latitud") == null ? "" : request.getParameter("latitud").trim();
+				String longitud = request.getParameter("longitud") == null ? "" : request.getParameter("longitud").trim();
+				String disponeRiego = request.getParameter("disponeRiego") == null ? "" : request.getParameter("disponeRiego").trim();
+				String disponeAsistencia = request.getParameter("disponeAsistencia") == null ? "" : request.getParameter("disponeAsistencia").trim();
+				String tipoSeguro = request.getParameter("tipoSeguro") == null ? "" : request.getParameter("tipoSeguro").trim();
+				String sucursalCanalId = request.getParameter("sucursalCanalId") == null ? "" : request.getParameter("sucursalCanalId").trim();
+				String aniosCultivo = request.getParameter("aniosCultivo") == null ? "" : request.getParameter("aniosCultivo").trim();
+				
+				AgriObjetoCotizacion agriObjetoCotizacion=new AgriObjetoCotizacion();
+				
+				/*campos para el id y detalle de la regla*/
+				String reglaId = "";
+				String reglaDetalle = "";
+				/*campos para el id y detalle de la regla*/
+				
+				Date dateCredito=null;
+				SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd");
+				if(fechaCredito!="")
+				{
+					try{
+						dateCredito=formatter.parse(fechaCredito);
+					}catch(Exception e){
+						System.out.print("fecha credito vacia");
+					}
+				}
+
+				Date dateSiembra=null;
+				if(fechaSiembra!=""){
+					dateSiembra=formatter.parse(fechaSiembra);
+				}
+
+				/*if(Integer.parseInt(tipoSeguro)==0){
+					Calendar c = Calendar.getInstance();    
+					c.setTime(new Date());
+					c.add(Calendar.DATE, -15);
+					Date dateMenor=c.getTime();
+					
+					Calendar cM = Calendar.getInstance();    
+					cM.setTime(new Date());
+					cM.add(Calendar.DATE, 15);
+					Date dateMayor=cM.getTime();
+	
+					if(!(dateSiembra.after(dateMenor) && dateSiembra.before(dateMayor)))
+						throw new Exception("No se puede realizar la cotización. Porque la fecha de siembra debe estar entre 15 días más y 15 días menos de la fecha actual.");
+				}*/
+
+				//Valido si existe la cotizacion
+				Cotizacion objetoCotizacion=cotizacionDAO.buscarPorId(cotizacionId);
+				if(objetoCotizacion!=null)
+				{
+					//
+					Double sumaAseguradaTotal=0.0;
+					Double primaNetaTotal=0.0;
+					//Obtengo el id del tipo de canal
+					AgriTipoCalculo agriTipoCalculo= new AgriTipoCalculo();
+					AgriTipoCalculoDAO agriTipoCalculoDAO = new AgriTipoCalculoDAO();
+					agriTipoCalculo=agriTipoCalculoDAO.BuscarPorNombre("PRONACA");
+					
+					//Obtengo el valor de la tabla de reglas
+					List<AgriRegla> reglas= agriReglaDAO.BuscarPorParametros(new BigInteger(provinciaId), new BigInteger(cantonId), new BigInteger(tipoCultivoId),agriTipoCalculo.getTipoCalculoId());
+					if(reglas.size()!=0)
+					{	
+						if(reglas.get(0).getCostoProduccion()!=0 || reglas.get(0).getTasa()!=0){
+							Boolean valido=false;
+							for(AgriRegla regla:reglas){
+								if(regla.getClicloId()!=null){
+									AgriCicloDAO cicloDAO=new AgriCicloDAO();
+									AgriCiclo ciclo = cicloDAO.BuscarPorId(regla.getClicloId());
+									Date fechafin=ciclo.getFechaFin();
+									Date fechaInicio=ciclo.getFechaInicio();
+									if(dateSiembra.after(fechaInicio) && dateSiembra.before(fechafin))
+										valido=true;
+								}
+								else {
+									if(regla.getAceptabilidadDesde()!=null && regla.getAceptabilidadHasta()!=null){
+										if(dateSiembra.after(regla.getAceptabilidadDesde()) && dateSiembra.before(regla.getAceptabilidadHasta()))
+											valido=true;
+									}
+									else
+										valido=true;
+								}
+							}
+							if(valido){							
+								
+								if(Integer.parseInt(tipoSeguro)==0){
+									sumaAseguradaTotal=reglas.get(0).getCostoProduccion()*Double.parseDouble(hectareasAsegurables);
+									primaNetaTotal=sumaAseguradaTotal*reglas.get(0).getTasa()/100;
+								}
+								else if(Integer.parseInt(tipoSeguro)==1){
+									//long diffMSec = (new Date()).getTime()-dateSiembra.getTime();
+									//long diff = (long)60 * (long)60 * (long)1000 * (long)24 * (long)365;
+									//long diffYears = (long) (diffMSec / diff);
+									Double costoMantenimiento = reglas.get(0).getCostoMantenimiento() * new Double(aniosCultivo) * Double.parseDouble(hectareasAsegurables);
+									sumaAseguradaTotal=reglas.get(0).getCostoProduccion() * Double.parseDouble(hectareasAsegurables) + costoMantenimiento;
+									primaNetaTotal=sumaAseguradaTotal*reglas.get(0).getTasa()/100;
+								}
+								else{
+									Double costoMantenimiento = reglas.get(0).getCostoMantenimiento() * new Double(1) * Double.parseDouble(hectareasAsegurables);
+									sumaAseguradaTotal=costoMantenimiento;
+									primaNetaTotal=sumaAseguradaTotal*reglas.get(0).getTasa()/100;
+								}
+								
+								reglaId = reglas.get(0).getReglaId().toString();
+								reglaDetalle = reglas.get(0).getObservaciones();						
+	
+							}
+							else{
+								throw new Exception("No se puede realizar la cotización. Porque la fecha de siembra no esta permitida en ningun ciclo.");
+							}
+	
+						}
+						else{
+							throw new Exception("No se puede realizar la cotización. Porque la provincia y ciudad seleccionadas no permite ese tipo de cultivo.");
+						}
+					}
+					else{
+						throw new Exception("No se puede realizar la cotización. Porque la provincia y ciudad seleccionadas no permite ese tipo de cultivo.");
+					}
+
+
+					//Cuento si ya hay al menos un detalle para la cotizacion
+					List<CotizacionDetalle> listadoDetalles=cotizacionDetalleDAO.buscarCotizacionDetallePorCotizacion(objetoCotizacion);
+					if(listadoDetalles.size()==0)
+					{
+						//Inserta el detalle de la cotización
+						
+						agriObjetoCotizacion.setProvinciaId(new BigInteger(provinciaId));
+						agriObjetoCotizacion.setCantonId(new BigInteger(cantonId));
+						agriObjetoCotizacion.setParroquiaId(new BigInteger(parroquiaId));
+						agriObjetoCotizacion.setTipoCultivoId(new BigInteger(tipoCultivoId));
+						agriObjetoCotizacion.setVariedad(variedad);
+						agriObjetoCotizacion.setAgricultorTecnificado(Boolean.parseBoolean(agricultorTecnificado));
+						agriObjetoCotizacion.setDisponeRiego(Boolean.parseBoolean(disponeRiego));
+						agriObjetoCotizacion.setDisponeAsistencia(Boolean.parseBoolean(disponeAsistencia));
+						agriObjetoCotizacion.setAgricultorTecnificado(Boolean.parseBoolean(agricultorTecnificado));
+						agriObjetoCotizacion.setDireccionSiembra(direccionSiembra);
+						agriObjetoCotizacion.setCostoProduccionQBE(Float.parseFloat(""+sumaAseguradaTotal));
+						if(!aniosCultivo.equals(""))
+							agriObjetoCotizacion.setAniosCultivo(Integer.parseInt(aniosCultivo));
+						if(!tipoSeguro.equals(""))
+							agriObjetoCotizacion.setTipoSeguro(Integer.parseInt(tipoSeguro));
+						else
+							agriObjetoCotizacion.setTipoSeguro(0);
+						if(!hectareasLote.equals(""))
+							agriObjetoCotizacion.setHectareasLote(Float.parseFloat(hectareasLote));
+						if(!latitud.equals("")){
+							
+							try{
+								agriObjetoCotizacion.setLatitud(Float.parseFloat(latitud));
+							}catch(Exception e){
+								System.out.println("Latitud vacia");
+							}
+						}
+						if(!longitud.equals(""))
+							try{
+								agriObjetoCotizacion.setLongitud(Float.parseFloat(longitud));
+							}catch(Exception e){
+								System.out.println("Longitud vacia");
+							}
+						if(!hectareasAsegurables.equals(""))
+							agriObjetoCotizacion.setHectareasAsegurables(Float.parseFloat(hectareasAsegurables));
+						if(!montoCredito.equals(""))
+							try{
+								agriObjetoCotizacion.setMontoCredito(Float.parseFloat(montoCredito));
+							}catch(Exception e){
+								System.out.println("Monto vacio");
+							}
+						if(!sucursalCanalId.equals(""))
+							agriObjetoCotizacion.setSucursalCanalId(new BigInteger(sucursalCanalId));
+
+						if(dateCredito!=null)
+							agriObjetoCotizacion.setFechaCredito(dateCredito);
+						if(dateSiembra!=null)
+							agriObjetoCotizacion.setFechaSiembra(dateSiembra);
+						if(!altitudNivelMar.equals(""))
+							agriObjetoCotizacion.setAltitudNivelMar(Float.parseFloat(altitudNivelMar));
+
+						agriObjetoCotizacion.setTipoOrigen("COTIZADOR_ONLINE");
+						
+						agriObjetoCotizacion.setTipoCalculo(reglaId);
+						agriObjetoCotizacion.setObservacion(reglaDetalle);
+						/***Proceso de creacion de las IdCotizaciones para facturacion***/
+						
+						AgriCotizacionMaxDAO busquedaMax = new AgriCotizacionMaxDAO();
+						AgriCotizacionMax numMaximo=busquedaMax.buscarTodos();
+						int numeroActual=numMaximo.getMaximo().intValue();
+						
+						agriObjetoCotizacion.setIdCotizacion2(new BigInteger(""+(numeroActual+1)));
+						agriObjetoCotizacion=agriObjetoCotizacionTransaction.crear(agriObjetoCotizacion);
+
+						//Creo la cotización detalle
+						CotizacionDetalle nuevoCotizacionDetalle=new CotizacionDetalle();
+						nuevoCotizacionDetalle.setCotizacion(objetoCotizacion);
+						nuevoCotizacionDetalle.setNecesitaInspeccion(false);
+						nuevoCotizacionDetalle.setTipoObjetoId(tipoObjetoDAO.buscarPorNombre("Agricola").getId());
+						nuevoCotizacionDetalle.setObjetoId(agriObjetoCotizacion.getObjetoCotizacionId().toString());
+						nuevoCotizacionDetalle.setSumaAseguradaItem(sumaAseguradaTotal);
+						nuevoCotizacionDetalle.setPrimaNetaItem(primaNetaTotal);
+						cotizacionDetalleTransaction.crear(nuevoCotizacionDetalle);
+
+						result.put("cotizacionId",objetoCotizacion.getId());
+						result.put("objetoGanaderoId",agriObjetoCotizacion.getObjetoCotizacionId());
+					}
+					else
+					{
+						//Recupero el objeto detalle para actualizar
+						CotizacionDetalle nuevoCotizacionDetalle=listadoDetalles.get(0);
+
+						//AgriObjetoCotizacion agriObjetoCotizacion;
+
+						//Valido si existe el objeto agricol para ese datalle, si existe lo recupero 
+						//caso contrario me toca crearlo
+
+						if(nuevoCotizacionDetalle.getObjetoId().equals(""))
+							agriObjetoCotizacion=new AgriObjetoCotizacion();
+						else
+							agriObjetoCotizacion=agriObjetoDAO.buscarPorId(new BigInteger(nuevoCotizacionDetalle.getObjetoId()));
+
+						//Inserta el detalle de la cotización
+
+						agriObjetoCotizacion.setProvinciaId(new BigInteger(provinciaId));
+						agriObjetoCotizacion.setCantonId(new BigInteger(cantonId));
+						agriObjetoCotizacion.setParroquiaId(new BigInteger(parroquiaId));
+						agriObjetoCotizacion.setTipoCultivoId(new BigInteger(tipoCultivoId));
+						agriObjetoCotizacion.setVariedad(variedad);
+						agriObjetoCotizacion.setAgricultorTecnificado(Boolean.parseBoolean(agricultorTecnificado));
+						agriObjetoCotizacion.setDisponeRiego(Boolean.parseBoolean(disponeRiego));
+						agriObjetoCotizacion.setDisponeAsistencia(Boolean.parseBoolean(disponeAsistencia));
+						agriObjetoCotizacion.setDireccionSiembra(direccionSiembra);
+						if(!aniosCultivo.equals(""))
+							agriObjetoCotizacion.setAniosCultivo(Integer.parseInt(aniosCultivo));
+						if(!tipoSeguro.equals(""))
+							agriObjetoCotizacion.setTipoSeguro(Integer.parseInt(tipoSeguro));
+						else
+							agriObjetoCotizacion.setTipoSeguro(0);
+						if(!hectareasLote.equals(""))
+							agriObjetoCotizacion.setHectareasLote(Float.parseFloat(hectareasLote));
+						if(!hectareasAsegurables.equals(""))
+							agriObjetoCotizacion.setHectareasAsegurables(Float.parseFloat(hectareasAsegurables));
+						if(!montoCredito.equals("")){
+							try{
+								agriObjetoCotizacion.setMontoCredito(Float.parseFloat(montoCredito));
+							}catch (Exception e) {
+								System.out.print("No hay monto de credito");
+							}
+						}
+						if(!latitud.equals("")){
+							try{
+								agriObjetoCotizacion.setLatitud(Float.parseFloat(latitud));
+							}catch (Exception e) {
+								System.out.print("No hay latitud");
+							}
+						}
+						if(!longitud.equals("")){
+							try{
+								agriObjetoCotizacion.setLongitud(Float.parseFloat(longitud));
+							}catch (Exception e) {
+								System.out.print("No hay longitud");
+							}
+						}
+						if(!sucursalCanalId.equals(""))
+							agriObjetoCotizacion.setSucursalCanalId(new BigInteger(sucursalCanalId));
+						if(dateCredito!=null)
+						{
+							try{
+								agriObjetoCotizacion.setFechaCredito(dateCredito);
+							}catch (Exception e) {
+								System.out.print("No hay fechaCredito");
+							}
+						}
+						if(fechaSiembra!=null)
+						{
+							agriObjetoCotizacion.setFechaSiembra(dateSiembra);
+						}
+						agriObjetoCotizacion.setAltitudNivelMar(Float.parseFloat(altitudNivelMar));
+						
+						agriObjetoCotizacion.setTipoOrigen("COTIZADOR_ONLINE");
+						
+						agriObjetoCotizacion.setTipoCalculo(reglaId);
+						agriObjetoCotizacion.setObservacion(reglaDetalle);
+
+						agriObjetoCotizacion=agriObjetoCotizacionTransaction.editar(agriObjetoCotizacion);
+
+						//Cambio los valores de la poliza
+						nuevoCotizacionDetalle.setSumaAseguradaItem(sumaAseguradaTotal);
+						nuevoCotizacionDetalle.setPrimaNetaItem(primaNetaTotal);
+						cotizacionDetalleTransaction.editar(nuevoCotizacionDetalle);
+
+
+						result.put("cotizacionId",objetoCotizacion.getId());
+						result.put("objetoGanaderoId",agriObjetoCotizacion.getObjetoCotizacionId());
+					}
+					objetoCotizacion.setSumaAseguradaTotal(sumaAseguradaTotal);
+					objetoCotizacion.setPrimaNetaTotal(primaNetaTotal.toString());
+					objetoCotizacion.setEtapaWizard(2);
+					cotizacionTransaction.editar(objetoCotizacion);
+				}
+			}
 			
 			/*COTIZACIONES ARCHIVO PLANO CARGA PREVIA*/
 			if(tipoConsulta.equalsIgnoreCase("crearArchivoPlano")){
@@ -676,6 +1003,14 @@
 						
 						agriObjetoCotizacion.setTipoCalculo(reglaId);
 						agriObjetoCotizacion.setObservacion(observaciones+""+reglaDetalle);
+						/***Proceso de creacion de las IdCotizaciones para facturacion***/
+						
+						AgriCotizacionMaxDAO busquedaMax = new AgriCotizacionMaxDAO();
+						AgriCotizacionMax numMaximo=busquedaMax.buscarTodos();
+						int numeroActual=numMaximo.getMaximo().intValue();
+						agriObjetoCotizacion.setCostoProduccionQBE(Float.parseFloat(""+sumaAseguradaTotal));
+						agriObjetoCotizacion.setIdCotizacion2(new BigInteger(""+(numeroActual+1)));
+						
 						
 						agriObjetoCotizacion=agriObjetoCotizacionTransaction.crear(agriObjetoCotizacion);
 
@@ -930,7 +1265,7 @@
 				
 				Cotizacion cotizacionC = new Cotizacion();
 				CotizacionDAO cotizacionCDAO = new CotizacionDAO();
-				cotizacionC = cotizacionCDAO.buscarPorId(cotizacionC.getId());
+				cotizacionC = cotizacionCDAO.buscarPorId(cotizacionId);
 				cotizacionC=cotizacionTransaction.editar(cotizacionC);
 						
 				
diff --git a/src/com/qbe/cotizador/servlets/producto/agricola/AgriProcesarCotizacionAP.java b/src/com/qbe/cotizador/servlets/producto/agricola/AgriProcesarCotizacionAP.java
--- a/src/com/qbe/cotizador/servlets/producto/agricola/AgriProcesarCotizacionAP.java
+++ b/src/com/qbe/cotizador/servlets/producto/agricola/AgriProcesarCotizacionAP.java
@@ -6,4 +6,5 @@
 import java.util.Calendar;
 import java.util.Date;
 import java.util.List;
+
 import javax.servlet.http.HttpSession;
@@ -9,3 +10,4 @@
 import javax.servlet.http.HttpSession;
+
 import net.sf.json.JSONArray;
 import net.sf.json.JSONObject;
@@ -10,5 +12,6 @@
 import net.sf.json.JSONArray;
 import net.sf.json.JSONObject;
+
 import com.qbe.cotizador.dao.cotizacion.CotizacionDAO;
 import com.qbe.cotizador.dao.cotizacion.CotizacionDetalleDAO;
 import com.qbe.cotizador.dao.cotizacion.EstadoDAO;
@@ -550,5 +553,5 @@
 					
 					//buscamos el tipo de cultivo por codigos de integracion en la tabla de AgriTipoCultivo
 					AgriTipoCultivoDAO agriTipoCultivoDAO = new AgriTipoCultivoDAO();
-					List<AgriTipoCultivo>agriTipoCultivoP=agriTipoCultivoDAO.BuscarTodosIntegracionOtros(nuevaCotizacion
+					List<AgriTipoCultivo>agriTipoCultivoP=agriTipoCultivoDAO.BuscarTodosSimilare(nuevaCotizacion
 									.getTipoCultivoNombre());
@@ -554,4 +557,5 @@
 									.getTipoCultivoNombre());
+					String TipoCultivoSinCoincidencias="";
 					//tomo fecha siembra para verificar a que ciclo pertenece
 					Date dateSiembra=  nuevaCotizacion.getFechaSiembra();
 					boolean noPerteneceCiclo= false;
@@ -561,7 +565,5 @@
 							List<AgriRegla> reglas = regla.BuscarPorParametros(
 									new BigInteger(provincia.getId()),
 									new BigInteger(canton.getId()),
-									rs.getTipoCultivoId(),
-									agriTipoCalculo.getTipoCalculoId());
-							
+											rs.getTipoCultivoId(),agriTipoCalculo.getTipoCalculoId());
 							for (AgriRegla rs2 : reglas) {
@@ -567,13 +569,15 @@
 							for (AgriRegla rs2 : reglas) {
-								if(rs2.getCostoProduccion()!=0.0 || rs2.getCostoProduccion()!=0){
-									try {
-										AgriCiclo ciclo = cicloDAO.BuscarPorId(rs2.getClicloId());//tomamos el ciclo para verificar a cual pertenece
-										Date fechafin=ciclo.getFechaFin();//fecha inicio ciclo
-										Date fechaInicio=ciclo.getFechaInicio();//fecha fin ciclo
-										
-										double costoP = rs2.getCostoProduccion();
-										//si los costos de produccion son iguales y las fechas de siembra coinciden con el ciclo pasa	
-										if (costoP == CostoProduccionPronaca) {
+								try {
+									
+									AgriCiclo ciclo = cicloDAO.BuscarPorId(rs2.getClicloId());//tomamos el ciclo para verificar a cual pertenece
+									Date fechafin=ciclo.getFechaFin();//fecha inicio ciclo
+									Date fechaInicio=ciclo.getFechaInicio();//fecha fin ciclo
+									
+									String costoP = ""+rs2.getCostoProduccion();
+									String costoA = ""+(nuevaCotizacion.getMontoAsegurado()/nuevaCotizacion.getNumeroHectareasAseguradas());
+									if(costoA.equals(""+rs2.getCostoProduccion())||costoA.equals(rs2.getCostoMantenimiento())){//verificamos que los costos de produccion sean iguales
+										TipoCultivoSinCoincidencias=""+rs2.getTipoCultivoId();//si son iguales le ponemos como temporal, asi si no calza por fechas calsa al menos el cultivo
+										if (costoP.equals(costoA)) {									
 											if(dateSiembra.after(fechaInicio) && dateSiembra.before(fechafin)){
 												CodigoTipoCultivoProcesado = ""
 														+ rs2.getTipoCultivoId();
@@ -577,12 +581,9 @@
 											if(dateSiembra.after(fechaInicio) && dateSiembra.before(fechafin)){
 												CodigoTipoCultivoProcesado = ""
 														+ rs2.getTipoCultivoId();
-												
-												break bucle1;
-												
-											}else{
-												
-												CodigoTipoCultivoProcesado = ""
-														+ rs2.getTipoCultivoId();
+												break bucle1;//si se encuentra la busqueda termina										
+											}
+											else{
+												TipoCultivoSinCoincidencias=""+ rs2.getTipoCultivoId();
 											}
 										}else{
@@ -587,5 +588,14 @@
 											}
 										}else{
-											CodigoTipoCultivoProcesado = ""
-													+ rs2.getTipoCultivoId();
+											costoP=""+rs2.getCostoMantenimiento();
+											if(costoP .equals(costoA)){
+												if(dateSiembra.after(fechaInicio) && dateSiembra.before(fechafin)){
+													CodigoTipoCultivoProcesado = ""
+															+ rs2.getTipoCultivoId();
+													break bucle1;//si se encuentra la busqueda termina										
+												}
+												else{
+													TipoCultivoSinCoincidencias=""+ rs2.getTipoCultivoId();
+												}
+											}
 										}
@@ -591,4 +601,2 @@
 										}
-									} catch (Exception e) {
-										continue;
 									}
@@ -594,5 +602,7 @@
 									}
+								} catch (Exception e) {
+									continue;
 								}
 							}
 						}
 					} else {
@@ -595,6 +605,14 @@
 								}
 							}
 						}
 					} else {
-						throw new Exception("no existe regla para ese tipo de cultivo en el lugar donde se piensa sembrar");
+						throw new Exception("Error Tipo de cultivo "+ nuevaCotizacion
+								.getTipoCultivoNombre()+ " no existe");
+					} 
+
+					if (CodigoTipoCultivoProcesado.equals("")) {//Si no encontraste tipo de cultivo traeme el que al menos coincida
+						CodigoTipoCultivoProcesado =TipoCultivoSinCoincidencias;
+						if(CodigoTipoCultivoProcesado.equals("")){//si aun asi no encuentra tomamos el primero que coincidir con el codigo de integracion
+							throw new Exception("No existe una regla de configuracion para este cultivo en este lugar de siembra Provincia:"+nuevaCotizacion.getProvinciaNombre()+ " Canton: "+nuevaCotizacion.getCantonNombre());
+						}					
 					}
@@ -600,9 +618,5 @@
 					}
-
-					if (CodigoTipoCultivoProcesado.equals("")
-							|| CodigoTipoCultivoProcesado.equals(" ")) {
-						throw new Exception("no existe regla para ese tipo de cultivo en el lugar donde se piensa sembrar");
-					}
+			
 					// Fin
 
 					cargaPreviaArchivo.setNombre_Completo(nuevaCotizacion.getClienteNombre()+" "+nuevaCotizacion.getClienteApellido());
@@ -651,6 +665,7 @@
 							.getUbicacionCultivo());
 					cargaPreviaArchivo.setTelefono(nuevaCotizacion
 							.getTelefono());
+					
 					cargaPreviaArchivo.setGpsX(nuevaCotizacion.getGpsX());
 					cargaPreviaArchivo.setGpsY(nuevaCotizacion.getGpsY());
 					// Estado activo
@@ -731,6 +746,7 @@
 					error.put("gpsY", nuevaCotizacionCopia.getGpsY());
 					error.put("detalle", e.getMessage());
 					errorList.add(error);
+					e.printStackTrace();
 				}
 			}
 
